@using System.Globalization

@{
    ViewData["Title"] = "Repertuar";
    var currentDate = DateTime.Today;
    var translateToPolish = new CultureInfo("pl-PL");

    var screeningDictionary = Model.Screenings.GroupBy(s => s.movie_id).ToDictionary(g => g.Key, g => g.OrderBy(i => i.screening_time).ToList());

    var genreDictionary = Model.MovieGenreJoins.GroupBy(mg => mg.movie_id).ToDictionary(g => g.Key, g => g.Select(mg => mg.genre_id).ToList());

    var availableHalls = Model.Halls.Where(h => h.available).ToList();
}

@model CinemaSite.ViewModels.AdminViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" />
}

<div class="admin-form">
    <button id="new-movie-button">Dodaj nowy film</button>

    <table id="movie-table">
        <thead>
            <tr>
                <th>Filmy</th>
            </tr>
        </thead>
        <tbody id="movies-list">
            @foreach (var movie in Model.Movies)
            {
                var genreIdList = genreDictionary.TryGetValue(movie.movie_id, out var genres) ? genres : new List<int>();
                var genreIdString = string.Join(",", genreIdList);
                var genreNameList = Model.Genres.Where(g => genreIdList.Contains(g.genre_id)).Select(g => g.genre_name);
                var genreNameString = string.Join(", ", genreNameList);

                if (genreIdList == null)
                {
                    genreIdString = "";
                }

                var posterImage = $"/Content/img{movie.poster_id}.jpg";

                <tr class="movie-row"
                    data-id="@movie.movie_id"
                    data-title="@movie.title"
                    data-forkids="@movie.for_kids"
                    data-poster="@posterImage"
                    data-summary="@movie.summary"
                    data-trailer="@movie.trailer_link"
                    data-genres="@genreIdString">
                    <td>
                        <div>
                            <div>
                                <p><strong>@movie.title</strong></p>
                            </div>
                            <div class="detaildiv">
                                <img src="@posterImage" alt="Plakat dla @movie.title" />
                                <p>@genreNameString</p>
                                <a href="https://www.youtube.com/watch?v=@Uri.EscapeDataString(movie.trailer_link)" target="_blank">Zwiastun</a>
                                <div class="control-box">
                                    <button data-id="@movie.movie_id"
                                            data-title="@movie.title"
                                            class="delete-button">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>


<div id="new-movie-modal" class="admin-modal" hidden style="position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 999;
    background-color: rbga(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);">
    <!--THIS ^^^ WILL BE MOVED TO CSS LATER!-->
    <div id="new-movie-modal-info" class="admin-modal-info" style="background-color: gray;">

        <button id="new-movie-xbutton" class="form-xbutton">X</button>
        
        <h2>Dane filmu</h2>
        <form asp-controller="Admin" asp-action="AddMovieDB" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <input asp-for="NewMovie.movie_id" type="hidden" id="nm-id" />

            <div>
                <label>Tytuł</label>
                <input asp-for="NewMovie.title" id="nm-title" required />
            </div>
            <div>
                <label>Plakat (plik musi mieć rozszerzenie .jpg)</label>
                <input asp-for="NewMovie.poster" id="nm-title" type="file" accept="image/jpg" required />
            </div>
            <div>
                <label>Streszczenie</label>
                <textarea asp-for="NewMovie.summary" id="nm-summary" required></textarea>
            </div>
            <div>
                <label>Link do zwiastunu (youtube video code)</label> <!--add like a tooltip or something later-->
                <input asp-for="NewMovie.trailer_link" id="nm-trailer" required />
            </div>
            <div>
                <label>Film dla dzieci?</label>
                <input asp-for="NewMovie.for_kids" id="nm-kids" type="checkbox" />
            </div>

            <fieldset>
                <legend>Żanry</legend>
                @foreach (var g in Model.Genres)
                {
                    <div class="genreBoxNew">
                        <label>@g.genre_name</label>
                        <input name="genreCheckbox" type="checkbox" value="@g.genre_id" />
                    </div>
                }
            </fieldset>

            <button type="submit">Zapisz danych filmu</button>
        </form>
    </div>
</div>

<div id="modal-movie" class="admin-modal" hidden style="position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 999;
    background-color: rbga(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);">
    <div id="modal-movie-info" class="admin-modal-info" style="background-color: gray;">
        
        <button id="xbutton" class="form-xbutton">X</button>

        <div>
            <h2>Dane filmu</h2>
            <form asp-controller="Admin" asp-action="EditMovieDB" method="post">
                @Html.AntiForgeryToken()

                <input asp-for="MovieEdit.movie_id" type="hidden" id="edit-id" />

                <div>
                    <label>Tytuł</label>
                    <input asp-for="MovieEdit.title" id="edit-title" />
                </div>
                <div>
                    <label>Streszczenie</label>
                    <textarea asp-for="MovieEdit.summary" id="edit-summary"></textarea>
                </div>
                <div>
                    <label>Link do zwiastunu (youtube video code)</label> <!--add like a tooltip or something later-->
                    <input asp-for="MovieEdit.trailer_link" id="edit-trailer" />
                </div>
                <div>
                    <label>Film dla dzieci?</label>
                    <input asp-for="MovieEdit.for_kids" id="edit-kids" type="checkbox" />
                </div>

                <fieldset>
                    <legend>Żanry</legend>
                    @foreach (var g in Model.Genres)
                    {
                        <div class="genreBox">
                            <label>@g.genre_name</label>
                            <input name="genreCheckbox" type="checkbox" value="@g.genre_id" />
                        </div>
                    }
                </fieldset>

                <button type="submit">Save Movie Details</button>
            </form>
        </div>

        <div>
            <h2>Screenings</h2>
            <form asp-controller="Admin" asp-action="EditScreeningDB" id="screening-form" method="post">
                @Html.AntiForgeryToken()
                <div id="screening-form-interior">
                    <!--set in js-->
                </div>
                <button type="button" class="create-screening">+</button>
                <button type="submit">Save Screening Details</button>
            </form>
        </div>
    </div>
</div>

<template id="screening-template">
    <div>
        <input name="movieId" type="hidden" />
        <input name="screeningId" type="hidden" />
        <input name="screeningTime" type="datetime-local" />
        <select name="hallId">
            @foreach (var h in availableHalls)
            {
                <option value="@h.hall_id">@h.hall_id  -  Seat Count: @((int)(h.rowcount * h.rowsize + 2))</option>
            }
        </select>

        <input name="isDubbing" type="hidden" />
        <input name="dubCheckbox" type="checkbox" />

        <button type="button" class="del-screening">SKASUJ</button> <!--for some reason defaults to type=submit-->
    </div>
</template>


<div id="modal-delete" hidden style="position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 999;
    background-color: rbga(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);">
    <!--THIS ^^^ WILL BE MOVED TO CSS LATER!-->
    <div id="modal-delete-confirm" style="background-color: gray;">
        <form asp-controller="Admin" asp-action="DeleteMovie" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" id="movie-to-delete">
            <label id="confirmation-message"></label>
            <button type="submit">Zatwierdź</button>
        </form>
    </div>
    <button id="xbutton-delete">Anuluj</button>
</div>

<!--don't move to the js, it literally passes data there-->
<script type="application/json" id="screenings-to-json">
    @Html.Raw(System.Text.Json.JsonSerializer.Serialize( //https://stackoverflow.com/questions/17617263/razor-syntax-error-serializing-asp-net-model-to-json-with-html-raw
        Model.Screenings.Select(sc => new { // ^ basically just makes a json-interpretable string
            screening_id = sc.screening_id,
            movie_id = sc.movie_id,
            screening_time = sc.screening_time.ToString("yyyy-MM-ddTHH:mm"), //input type=datetime(-local?) requires this format
            hall_id = sc.hall_id,
            dubbing = sc.dubbing
        }) //as the script it's just the text content - so it can be read w/ getelementbyid later
    ))
</script>
<script type="application/json" id="moviegenres-to-json">
    @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.MovieGenreJoins.Select(mg => new {
            movie_id = mg.movie_id,
            genre_id = mg.genre_id
        })
    ))
</script>

@section Scripts {
    <script src="~/js/modal-admin.js" asp-append-version="true" defer></script>
}