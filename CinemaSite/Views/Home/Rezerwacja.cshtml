@{
    ViewData["Title"] = "Rezerwacja";

    var rowCount = Model.Hall.rowcount;
    var columnCount = Model.Hall.rowsize; //last row is 2 wider
    var columnCountForGrid = columnCount + 3; //for that ^

    var seatsWithTickets = Model.Tickets.Where(t => t.ticket_status == 2).Select(t => t.seat_id).ToHashSet();

    var seatTypeDictionary = Model.SeatTypes.ToDictionary(st => st.seat_type_id, st => st.seat_type);

    var ticketTypeDictionary = Model.TicketTypes.ToDictionary(tt => tt.ticket_type_id, tt => tt.ticket_type);
}

@model CinemaSite.ViewModels.RezerwacjaViewModel;

<template id="dropdown-template">
    <select name="ticketTypesPost" class="ttDropdown">
        @foreach (var tt in Model.TicketTypes)
        {
            <option value="@tt.ticket_type_id" data-price="@tt.price">@tt.ticket_type - @((tt.price/100.0).ToString("F2"))zł</option>
        }
    </select>
</template>



<!--will be moved to css file later-->
<style>
    #seat-grid {
        display: grid;
        grid-template-rows: repeat(@rowCount, 25px);
        grid-template-columns: repeat(@columnCountForGrid, 25px);
        gap: 5px;
        justify-content: center;
        align-content: center;
    }

    .seat-square {
        width: 25px;
        height: 25px;
        cursor: pointer;
    }

    .seat-square.open {
        background: #000000;
    }

    .seat-square.taken {
        background: #646464;
        cursor: not-allowed;
    }

    .seat-square.selected {
        background: #d8315b;
    }
</style>

<div>
    <h1>@Model.Movie.title</h1>
    <div id="seat-grid">
        @for (int i = 1; i < Model.Hall.rowcount; i++)
        {
            char rowLabel = (char)('A' + i - 1);

            <div style="width:25px; height: 25px;">
                <p>@rowLabel</p>
            </div>

            @for (int j = 1; j <= (int)(Model.Hall.rowsize / 2); j++)
            {
                var thisSeat = Model.Seats.FirstOrDefault(s => (int)(s.rowNum - 'A' + 1) == i && s.columnNum == j); //rowNum is a char in the database
                var taken = seatsWithTickets.Contains(thisSeat.seat_id);

                <div class="seat-square @(taken ? "taken" : "open")"
                        data-seat-id="@thisSeat.seat_id"
                        data-row="@i"
                        data-column="@j"
                        data-seat-type="@thisSeat.seat_type_id"
                        data-seat-name="@seatTypeDictionary[thisSeat.seat_type_id]"
                        title="@j">
                    <p>@j</p>
                </div>
            }

            <div style="width:25px; height:25px;"></div>
            <div style="width:25px; height:25px;"></div>

            @for (int k = (int)(Model.Hall.rowsize / 2) + 1; k <= Model.Hall.rowsize; k++)
            {
                var thisSeat = Model.Seats.FirstOrDefault(s => (int)(s.rowNum - 'A' + 1) == i && s.columnNum == k);
                var taken = seatsWithTickets.Contains(thisSeat.seat_id);
                var seatType = thisSeat.seat_type_id;

                <div class="seat-square @(taken ? "taken" : "open")"
                        data-seat-id="@thisSeat.seat_id"
                        data-row="@i"
                        data-column="@k"
                        data-seat-type="@thisSeat.seat_type_id"
                        data-seat-name="@seatTypeDictionary[thisSeat.seat_type_id]"
                        title="@k">
                    <p>@k</p>
                </div>
            }
        }

        <!--last row has 2 extra seats-->

        <div style="width:25px; height: 25px;">
            <p>@((char)('A' + rowCount - 1))</p>
        </div>

        @for (int h = 1; h <= Model.Hall.rowsize + 2; h++)
        {
            var thisSeat = Model.Seats.FirstOrDefault(s => (int)(s.rowNum - 'A' + 1) == Model.Hall.rowcount && s.columnNum == h);
            var taken = seatsWithTickets.Contains(thisSeat.seat_id);

            <div class="seat-square @(taken ? "taken" : "open")"
                    data-seat-id="@thisSeat.seat_id"
                    data-row="@((int)('A' + rowCount - 1))"
                    data-column="@h"
                    data-seat-type="@thisSeat.seat_type_id"
                    data-seat-name="@seatTypeDictionary[thisSeat.seat_type_id]"
                    title="@h">
                <p>@h</p>
            </div>
        }
    </div>
</div>

<div id="cart-container">
    <form id="pseudo-cart" asp-controller="Home" asp-action="RedirectCheckout" method="POST">
        <input name="screeningIdPost" type="hidden" value="@Model.Screening" />

        <table>
            <thead>
                <tr>
                    <th>Miejsce</th>
                    <th>Rodzaj siedzenia</th>
                    <th>Rodzaj biletu</th>
                    <th>Cena</th>
                </tr>
            </thead>
            <tbody id="cart-items">
                <tr>

                </tr>
            </tbody>
        </table>
        <p id="total"></p>

        <button type="submit">Head to Checkout (please work this time)</button>
    </form>
</div>


@section Scripts {
    <script src="~/js/seat-selection.js" asp-append-version="true" defer></script>
}